<?xml version="1.0"  encoding="utf-8" ?>
<TrbNetEntity xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:noNamespaceSchemaLocation="../schema/TrbNetEntity.xsd"
              name="Nxyter"
              address="8000"
              >
  <description>Registers for the Nxyter Readout</description>

  <group name="DataValidate"
         address="0120"  size="6"  purpose="status"  mode="r"  continuous="true">

    <register name="InvalidFrames" address="0000" purpose="status">
      <description>Number of invalid frames</description>
      <field name="InvalidFrames" start="0" bits="16" format="unsigned" />
    </register>

    <register name="OverflowCount" address="0001" purpose="status">
      <description>Number of hit overflows</description>
      <field name="OverflowCount" start="0" bits="16" format="unsigned" />
    </register>

    <register name="PileupCount" address="0002" purpose="status">
      <description>Pileup Counter</description>
      <field name="PileupCount" start="0" bits="16" format="unsigned" />
    </register>

    <register name="ParityErrorCount" address="0003" purpose="status">
      <description>Parity Error Counter</description>
      <field name="ParityErrorCount" start="0" bits="16" format="unsigned" />
    </register>

    <group name="NxyterRates"
           address="0004"  size="2"  purpose="status"  mode="r"  continuous="true">
      <register name="HitRate" address="0000" purpose="status">
        <description>Total hit rate summed over all channels</description>
        <field name="HitRate" start="0" bits="32" format="unsigned" unit="Hz"/>
      </register>

      <register name="FrameRate" address="0001" purpose="status">
        <description>Rate of Incoming Nxyter Frames, must be 31.25MHz</description>
        <field name="FrameRate" start="0" bits="32" format="unsigned" unit="Hz"/>
      </register>
    </group>

  </group>


  <group name="TriggerHandler"
         address="0160"  size="4"  purpose="config"  mode="rw"  continuous="true">
    
    <register name="TestPulseEnable" address="0000" purpose="config">
      <description>Enable test pulse</description>
      <field name="TestPulseEnable" start="0" bits="1" format="boolean"/>
    </register>  

    <register name="TestPulseDelay" address="0001" purpose="config">
      <description>Delay of the testpulse after Trigger</description>
      <field name="TestPulseDelay" start="0" bits="12" format="unsigned" unit="ns" scale="4"/>
    </register>   

    <register name="TriggerRate" address="0002" purpose="status" mode="r">
      <description>Accepted incoming Trigger Rate</description>
      <field name="TriggerRate" start="0" bits="28" format="unsigned" unit="Hz"/>
    </register>   

    <register name="InvalidTriggerCount" address="0003" purpose="status" mode="r">
      <description>Invalid Timing Trigger counter</description>
      <field name="InvalidTriggerCount" start="0" bits="16" format="unsigned"/>
    </register>   
    
  </group>  


  <group name="TestPulse"
         address="0140"  size="2"  purpose="config"  mode="rw"  continuous="true">
    
    <register name="TestPulseLength" address="0000" purpose="config">
      <description>Length of Trigger TestPulse</description>
      <field name="TestPulseLength" start="0" bits="12" format="unsigned" unit="ns" scale="4"/>
    </register>   

    <register name="TestPulseRate" address="0001" purpose="status" mode="r">
      <description>Testpulse Rate</description>
      <field name="TestPulseRate" start="0" bits="28" format="unsigned" unit="Hz"/>
    </register>   
    
  </group> 


  <group name="TriggerValidate"
         address="0180"  size="15"  purpose="config"  mode="rw"  continuous="false">
    <register name="ReadoutMode" address="0000" purpose="config">
      <description>Readout mode selection</description>
      
      <field name="SelfTrigger" start="3" bits="1" format="boolean">
        <description>Self Trigger Mode</description>
      </field>
      
      <field name="TSSelectOff" start="2" bits="1" format="boolean">
        <description>TimeStamp Selection Filter Off</description>
      </field>

      <field name="StatusSelect" start="0" bits="2" format="enum">
        <description>Timestamp Selection Mode</description>
        <enumItem value="0">Ovfl, Parity Bits valid</enumItem>
        <enumItem value="1">Ovfl, Parity, Pileup Bits valid</enumItem>
        <enumItem value="2">ignore Status Bits</enumItem>
        <enumItem value="3">ignore Status Bits</enumItem>
      </field>
    </register>    

    <register name="TriggerWindowOffset" address="0001" purpose="config">
      <description>Delay of the trigger window</description>
      <field name="TriggerWindowOffset" start="0" bits="11" format="signed" unit="ns" scale="4"/>
    </register>     
    
    <register name="TriggerWindowWidth" address="0002" purpose="config">
      <description>Width of the trigger window</description>
      <field name="TriggerWindowWidth" start="0" bits="10" format="unsigned" unit="ns" scale="4"/>
    </register>     
    
    <register name="CtsTriggerDelay" address="0003" purpose="config">
      <description>CTS Trigger Delay</description>
      <field name="CtsTriggerDelay" start="0" bits="10" format="unsigned" unit="ns" scale="4"/>
    </register>     
    
    <register name="ReadoutTimeMax" address="0004" purpose="config">
      <description>Maximal read-out time</description>
      <field name="ReadoutTimeMax" start="0" bits="10" format="unsigned" unit="ns" scale="10"/>
    </register>     
    
    <register name="FpgaTsOffset" address="0005" purpose="config">
      <description>Adds positive offset to FPGA Timestamp</description>
      <field name="FpgaTsOffset" start="0" bits="12" format="unsigned" unit="ns" scale="4"/>
    </register>
    
    <register name="BusyTime" address="0006" purpose="status" mode="r">
      <description>Maximal read-out time</description>
      <field name="BusyTime" start="0" bits="12" format="unsigned" unit="ns" scale="10"/>
    </register>  
    
    <register name="TimestampRef" address="0007" purpose="status" mode="r">
      <description>Internal reference timestamp of current event</description>
      <field name="TimestampRef" start="0" bits="12" format="unsigned" unit="ns" scale="4"/>
    </register>  
    
    <register name="WindowLowerThreshold" address="0008" purpose="status" mode="r">
      <description>Lower timestamp limit of data selection window</description>
      <field name="WindowLowerThreshold" start="0" bits="12" format="unsigned" unit="ns" scale="4"/>
    </register>  
    
    <register name="TSWindowErrorCount" address="0009" purpose="status" mode="r">
      <description>TS Window Error Counter</description>
      <field name="TSWindowErrorCount" start="0" bits="16" format="unsigned"/>
    </register>  
    
    <register name="DataFifoDelay" address="000a" purpose="status" mode="r">
      <description>Current Data-Fifo delay value</description>
      <field name="DataFifoDelay" start="0" bits="7" format="unsigned" unit="ns" scale="32"/>
    </register>
    

    <register name="ChannelDone" address="000b" purpose="status" mode="r" repeat="4">
      <description>Data channel read-out finished</description>
      <field name="ChannelDone" start="0" bits="32" format="bitmask"/>
    </register>  

  </group>


  <group name="DataReceiver"
         address="0500"  size="13"  purpose="status"  mode="rw"  continuous="true">

    <register name="CurrentTimestamp" address="0000" purpose="status" mode="r">
      <description>Current Timestamp Value read from Fifo</description>
      <field name="CurrentTimestamp" start="0" bits="32" format="unsigned" />
    </register>
    
    <register name="TimestampFifoStatus" address="0001" purpose="status" mode="r">
      <description>Status of the timestamp Fifo</description>
      
      <field name="TSFifoFull" start="0" bits="1" format="boolean" errorflag="true" mode="r">
        <description>Timestamp Fifo full</description>
      </field>  
      
      <field name="TSFifoEmpty" start="1" bits="1" format="boolean" mode="r">
        <description>Timestamp Fifo Empty</description>
      </field>  
      
      <field name="TSFifoAlmostEmpty" start="2" bits="1" format="boolean" mode="r">
        <description>Timestamp Fifo Almost Empty</description>
      </field>        
    
      <field name="NxFrameSynced" start="31" bits="1" format="boolean" mode="r">
        <description>Synchronized to Nxyter Frame</description>
      </field>        
    </register>   
    
    <register name="ResyncCounter" address="0002" purpose="status" mode="r">
      <description>Number of Resyncs</description>
      <field name="ResyncCounter" start="0" bits="32" format="unsigned" />
    </register>

    <register name="ParityErrorCounter" address="0003" purpose="status" mode="r">
      <description>Number of Parity Errors</description>
      <field name="ParityErrorCounter" start="0" bits="32" format="unsigned" errorflag="true" />
    </register>
    
    <register name="PLLNotLockCount" address="0004" purpose="status" mode="r">
      <description>ADC Sampling PLL Clock Not Lock Counter</description>
      <field name="PLLNotLockCount" start="0" bits="32" format="unsigned" errorflag="true" />
    </register>

    <register name="JohnsonCtrSync" address="0005" purpose="config" mode="rw">
      <description>johnson_counter_sync (experts only)</description>
      <field name="JohnsonCtrSync" start="0" bits="2" format="unsigned"/>
    </register>

    <register name="PllDPhase" address="0006" purpose="config" mode="rw">
      <description>PLL ADC Sampling Clock DPHASE</description>
      <field name="PllDPhase" start="0" bits="4" format="unsigned" scale="2" unit="ns" />
    </register>
    
    <register name="PllFineDelb" address="0007" purpose="config" mode="rw">
      <description>PLL ADC Sampling Clock FINEDELB</description>
      <field name="PllFineDelb" start="0" bits="4" format="unsigned" scale="125" unit="ps" />
    </register>

    <register name="ADCValue" address="0008" purpose="status" mode="r">
      <description>Current ADC value</description>
      <field name="ADCValue" start="0" bits="32" format="unsigned"/>
    </register>
    
    <register name="ADCInputErrorEnable" address="0009" purpose="status" mode="rw">
      <description>"ADC Input Error Enable</description>
      <field name="ADCInputErrorEnable" start="0" bits="1" format="boolean" />
    </register>
    
    <register name="ADCInputErrorCtr" address="000a" purpose="status" mode="r">
      <description>ADC Input Error Counter</description>
      <field name="ADCInputErrorCtr" start="0" bits="16" format="unsigned" />
    </register>

    <register name="NXDataClkOK" address="000b" purpose="status" mode="r">
      <description>Nyxter Data Clock OK</description>
      <field name="NXDataClkOK" start="0" bits="1" format="boolean" />
    </register>

    <register name="ADCResetCounter" address="000c" purpose="status" mode="r">
      <description>ADC Handler Reset Counter</description>
      <field name="ADCResetCounter" start="0" bits="16" format="unsigned" />
    </register>

  </group>
  
  <group name="NxyterI2C"
         address="0200" purpose="config"  mode="rw"  continuous="false">

    <group name="NxMainReg"
           address="0050"  size="7"  purpose="config"  mode="rw" continuous="true">
      
      <register name="NxyterClock" address="0000" purpose="config" mode="rw" >
        <description>Nxyter Main Clock enable</description>
        <field name="NxyterClock" start="0" bits="1" format="boolean"/>
      </register> 
      
      <register name="NxPolarity" address="0001" purpose="config" mode="rw" >
        <description>Nxyter Input Polarity (0 = negative, 1 = positive)</description>
        <field name="NxPolarity" start="0" bits="1" format="unsigned"/>
      </register>
      
      <register name="NxTestPol" address="0002" purpose="status" mode="r" >
        <description>Nxyter Testpulse Polarity (1 = negative, 0 = positive)</description>
        <field name="NxTestPol" start="0" bits="1" format="unsigned"/>
      </register>

      <register name="NxTestPulse" address="0003" purpose="config" mode="rw" >
        <description>Nxyter Testpulse enable</description>
        <field name="NxTestPulse" start="0" bits="1" format="boolean"/>
      </register>

      <register name="NxTestTrigger" address="0004" purpose="config" mode="rw" >
        <description>Nxyter Testtrigger enable</description>
        <field name="NxTestTrigger" start="0" bits="1" format="boolean"/>
      </register>
      
      <register name="NxTestChannel" address="0005" purpose="config" mode="rw" >
        <description>Nxyter Testpulse Channel Group (0=0,4,.. 1=1,5,.. 2=2,6,.. 3=3,7,..)</description>
        <field name="NxTestChannel" start="0" bits="2" format="unsigned"/>
      </register>
      
      <register name="I2COnline" address="0006" purpose="status" mode="r" >
        <description>I2C Online, i.e. Nxyter is connected</description>
        <field name="I2COnline" start="0" bits="1" format="boolean"/>
      </register>
    
    </group>
  
    <group name="I2CRegs"
           address="0000"  size="46"  purpose="status"  mode="rw" continuous="true">
      
      <register name="I2CRegister" address="0000" purpose="config" repeat="46">
        <description>Nxyter I2C Register</description>
        
        <field name="I2CWToken" start="31" bits="1" format="bitmask" purpose="status" mode="r">
          <description>I2C Write Token</description>
        </field> 
        
        <field name="I2CRToken" start="30" bits="1" format="bitmask" purpose="status" mode="r">
          <description>I2C Read Token</description>
        </field> 
        
        <field name="I2CReserved" start="29" bits="1" format="bitmask" purpose="status" mode="r">
          <description>Dummy Register</description>
        </field> 
      
        <field name="I2CValue" start="0" bits="8" format="unsigned" purpose="config" mode="rw">
          <description>I2C Register Value</description>
        </field>
        
      </register>
    </group>
  </group>

  <group name="NxyterDAC"
         address="0300"  size="129"  purpose="status"  mode="rw" continuous="true">

    <register name="DACRegister" address="0000" purpose="config" repeat="129">
      <description>Nxyter DAC Register</description>
      
      <field name="DACWToken" start="31" bits="1" format="bitmask" purpose="status" mode="r">
        <description>DAC Write Token</description>
      </field> 
      
      <field name="DACRToken" start="30" bits="1" format="bitmask" purpose="status" mode="r">
        <description>DAC Read Token</description>
      </field> 
      
      <field name="ChannelDown" start="5" bits="1" format="bitmask" purpose="config" mode="rw">
        <description>Channel Down</description>
      </field> 
      
      <field name="TrimValue" start="0" bits="5" format="unsigned" purpose="config" mode="rw">
        <description>DAC Trim Value</description>
      </field> 
      
    </register>
  </group>

</TrbNetEntity>
