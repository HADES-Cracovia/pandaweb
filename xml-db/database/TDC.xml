<?xml version="1.0"  encoding="utf-8" ?>
<TrbNetEntity xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xsi:noNamespaceSchemaLocation="TrbNetEntity.xsd"
              name="TDC"
              address="c000"
              >
  <description>An FPGA-based tapped-delay line time-to-digital converter (TDC)</description>
  <!--===========================================-->
  <!-- TDC Status registers (mostly statistics)  -->
  <!--===========================================-->

  <group name="Status" purpose="statistics" address="0100"  mode="r" continuous="true">
    <register name="Basic" address="0000" purpose="status">
      <field name="ReadoutFSM" start="0"   size="4" format="enum" purpose="status">
        <description>Debug word of the TDC readout FSM</description>
        <enumItem value="1">IDLE</enumItem>
        <enumItem value="2">WAIT_FOR_TRG_WIND_END</enumItem>
        <enumItem value="3">RD_CH</enumItem>
        <enumItem value="4">WAIT_FOR_LVL1_TRG_A</enumItem>
        <enumItem value="5">WAIT_FOR_LVL1_TRG_B</enumItem>
        <enumItem value="6">WAIT_FOR_LVL1_TRG_C</enumItem>
        <enumItem value="7">SEND_STATUS</enumItem>
        <enumItem value="8">SEND_TRG_RELEASE_A</enumItem>
        <enumItem value="9">SEND_TRG_RELEASE_B</enumItem>
        <enumItem value="F">OTHERS</enumItem>
      </field>
      <field name="WriteoutFSM" start="4"   size="4" format="enum">
        <description>Debug word of the TDC writeout FSM</description>
        <enumItem value="1">IDLE</enumItem>
        <enumItem value="2">WR_CH</enumItem>
        <enumItem value="F">OTHERS</enumItem>
      </field>
      <field name="ChannelCount" start="8" size="8" format="unsigned">
        <description>Number of implemented channels</description>
      </field>
      <field name="RefTimeSyncedTo100" start="16" format="boolean">
        <description>Reference time synchronised to 100 MHz Trb-Net
        clock</description>
      </field>
      <field name="TriggerType" start="28" size="4" format="boolean" mode="rw" purpose="config">
        <description>Trigger type</description>
      </field>
    </register>

    <memory name="EmptyChannels" address="0001" size="2" mode="w" purpose="trigger">
      <field name="Mask" start="0" size="64" format="bitmask">
        <description>Empty the signals/hits of the specific channel.
        LSB is channel 1.</description>
      </field>
    </memory>

    <register name="TriggerWindow" address="0003" purpose="status">
      <field name="Before" start="0" size="11" format="time" unit="ns" scale="5">
        <description>Trigger window width BEFORE the trigger with
        granularity of 5 ns</description>
      </field>
      <field name="After" start="16" size="11" format="time" unit="ns" scale="5">
        <description>Trigger window width AFTER the trigger with
        granularity of 5 ns</description>
      </field>
      <field name="Enable" start="31" format="boolean">
        <description>Trigger window enabled?</description>
      </field>
    </register>

    <register name="Trigger" address="0004">
      <field name="Counter" start="0" size="24" format="unsigned">
        <description>Number of valid triggers received</description>
      </field>
    </register>

    <register name="TimingTrigger" address="0005">
      <field name="Counter" start="0" size="24" format="unsigned">
        <description>Number of valid timing triggers
        received</description>
      </field>
    </register>

    <register name="NoTimingTrigger" address="0006">
      <field name="Counter" start="0" size="24" format="unsigned">
        <description>Number of valid triggers received which are not
        timing triggers</description>
      </field>
    </register>

    <register name="InvalidTrigger" address="0007">
      <field name="Counter" start="0" size="24" format="unsigned">
        <description>Number of invalid triggers received</description>
      </field>
    </register>

    <register name="MultiTimingTrigger" address="0008">
      <field name="Counter" start="0" size="24" format="unsigned">
        <description>Number of multi timing triggers received
        (triggers received before trigger is released)</description>
      </field>
    </register>

    <register name="SpuriousTrigger" address="0009">
      <field name="Counter" start="0" size="24" format="unsigned">
        <description>Number of spurious triggers received (in case of
        timing trigger is validated although it was a
        timing-trigger-less trigger)</description>
      </field>
    </register>

    <register name="WrongReadouts" address="000a">
      <field name="Counter" start="0" size="24" format="unsigned">
        <description>Number of wrong readouts due to spurious triggers</description>
      </field>
    </register>

    <register name="Spikes" address="000b">
      <field name="Counter" start="0" size="24" format="unsigned">
        <description>Number of spikes (pulses narrower than 40 ns)
        detected at the timing trigger input</description>
      </field>
    </register>

    <register name="Idle" address="000c">
      <field name="Time" start="0" size="24" format="time" unit="ns" scale="10">
        <description>Total time length, that the readout FSM waited in
        the idle state (with granularity of 10 ns)</description>
      </field>
    </register>
    
    <register name="Wait" address="000d">
      <field name="Time" start="0" size="24" format="time" unit="ns" scale="10">
        <description>Total time length, that the readout FSM waited in
        the wait states (with granularity of 10 ns)</description>
      </field>
    </register>

    <register name="TotalEmptyChannels" address="000e">
      <field name="Counter" start="0" size="24" format="unsigned">
        <description>Total number of empty channels since the last reset
        signal</description>
      </field>
    </register>

    <register name="Release" address="000f">
      <field name="Counter" start="0" size="24" format="unsigned">
        <description>Number of release signals sent</description>
      </field>
    </register>

    <register name="Readout" address="0010">
      <field name="Time" start="0" size="24" format="time" unit="ns" scale="10">
        <description>Total time length of the readout process 
        (with granularity of 10 ns)</description>
      </field>
    </register>

    <register name="Timeout" address="0011">
      <field name="Counter" start="0" size="24" format="unsigned">
        <description>Number of timeouts detected (too long delay after
        the timing trigger)</description>
      </field>
    </register>

    <register name="Finished" address="0012">
      <field name="Counter" start="0" size="24" format="unsigned">
        <description>Number of sent finished signals</description>
      </field>
    </register>
    
  </group>
  
  <!--===========================================-->
  <!-- TDC control registers                     -->
  <!--===========================================-->
  <group name="Control"
         address="0800" purpose="config"  mode="rw"  continuous="true">
    <register name="Basic" address="0000">
      <field name="DebugOutput" start="0" size="4" format="enum">
        <description>Enables different signals to the HPLA* output for
        debugging with logic analyser</description>
      </field>
      <field name="DebugMode" start="4" format="boolean">
        <description>Enables the Debug Mode. Different statistics and
        debug words are sent after every trigger</description>
      </field>
      <field name="ResetCounters" start="8" purpose="trigger" mode="w">
        <description>Resets the internal counters</description>
      </field>
      <field name="TriggerMode" start="0" size="12" format="enum">
        <description>Select the trigger mode: With trigger mode or
        trigger-less mode</description>
        <enumItem value="0">TRIGGERED</enumItem>
        <enumItem value="1">TRIGGERLESS</enumItem>
      </field>
    </register>

    <register name="TriggerWindow" address="0001">
      <field name="Before" start="0" size="11" format="time" unit="ns" scale="5">
        <description>Trigger window width BEFORE the trigger with
        granularity of 5 ns</description>
      </field>
      <field name="After" start="16" size="11" format="time" unit="ns" scale="5">
        <description>Trigger window width AFTER the trigger with
        granularity of 5 ns. ATTENTION: Minimum value is x"00f"!</description>
      </field>
      <field name="Enable" start="31" format="boolean">
        <description>Trigger window enable</description>
      </field>
    </register>

    <memory name="Channel" address="0002" size="2">
      <field name="Enable" start="0" size="64" format="bitmask">
        <description>Enable signals/hits of the specific channel.
        LSB is channel 1.</description>
      </field>
    </memory>

    <register name="DataTransferLimit" address="0004">
      <field name="MaxWords" start="0" size="8" format="unsigned">
        <description>Defines number of data words per channel to be
        read-out. Set it to 0x80 for full readout.</description>
      </field>
    </register>

  </group>
</TrbNetEntity>
